name: Build, Test & Publish to GitHub Packages

# üéØ Purpose: Self-publishing pipeline using PackageRepoProvider itself!
# This workflow validates and publishes the module to GitHub Packages using its own logic.
#
# ÔøΩü•ö Bootstrap Problem (Henne-Ei):
# How to publish PackageRepoProvider using itself if it's not published yet?
# Solution: Toggle between LOCAL Git checkout (bootstrap) and GitHub Packages (stable)
#
# üìã Workflow Inputs:
# - use-psgallery: Toggle PackageRepoProvider source (GitHub Packages vs LOCAL)
#
# üìã Repository Variables (optional):
# - USE_GITHUB_PACKAGES: Global default for module loading strategy
#
# üîÑ Module Loading Strategy:
# - LOCAL (default):      Git checkout, bootstrap phase, breaking changes
# - GitHub Packages:      Published version, stable, one-version-behind
#
# Note: Pipeline uses ONLY PackageRepoProvider public API (no direct provider imports!)
#       Provider routing happens transparently inside PackageRepoProvider.

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
      use-psgallery:
        description: 'Load PackageRepoProvider from GitHub Packages (vs LOCAL)'
        required: false
        default: false
        type: boolean

env:
  # üîÑ Module Loading Strategy (Bootstrap Pattern - Henne-Ei Problem)
  # Question: How to publish PackageRepoProvider using itself if it's not published yet?
  # 
  # Controls where K.PSGallery.PackageRepoProvider is loaded from:
  # - false/not set = LOCAL Git checkout (default, bootstrap phase, breaking changes)
  #                   Provider also loaded from Git (not yet published as RequiredModules)
  # - true          = GitHub Packages (self-hosted, stable, one-version-behind)
  #                   Provider loaded from GitHub Packages (after first publish)
  USE_GITHUB_PACKAGES: ${{ inputs.use-psgallery || vars.USE_GITHUB_PACKAGES || 'false' }}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Checkout GitHub Provider (bootstrap dependency)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider.GitHub
          path: K.PSGallery.PackageRepoProvider.GitHub
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          
          # Install latest PREVIEW version of PSResourceGet (1.2.0-preview3 fixes "No author" bug)
          Write-Host "Installing Microsoft.PowerShell.PSResourceGet PREVIEW..."
          Install-PSResource -Name Microsoft.PowerShell.PSResourceGet -Prerelease -Scope CurrentUser -TrustRepository -Reinstall -Verbose
          
          # Verify version
          $version = (Get-Module Microsoft.PowerShell.PSResourceGet -ListAvailable | Sort-Object Version -Descending | Select-Object -First 1).Version
          Write-Host "‚úÖ PSResourceGet Version: $version"
      
      - name: Run Pester tests
        shell: pwsh
        run: |
          Install-PSResource -Name Pester -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          Invoke-Pester -Path ./Tests/Private/ -Output Detailed
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-PSResource -Name PSScriptAnalyzer -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          
          # Only scan production code (Public + Private folders), exclude tests and trailing whitespace warnings
          $paths = @('./Public', './Private')
          $results = $paths | ForEach-Object { 
            Invoke-ScriptAnalyzer -Path $_ -Recurse -Severity Error,Warning -ExcludeRule PSAvoidTrailingWhitespace,PSReviewUnusedParameter 
          }
          
          if ($results) {
            Write-Host "‚ùå PSScriptAnalyzer found $($results.Count) issues:"
            $results | Format-Table -Property RuleName,Severity,ScriptName,Line -AutoSize
            throw "PSScriptAnalyzer validation failed"
          }
          Write-Host "‚úÖ PSScriptAnalyzer passed!"
      
      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if (-not $env:GITHUB_TOKEN) {
            throw "GITHUB_TOKEN is not available"
          }
          
          # ÔøΩ Load PackageRepoProvider based on bootstrap strategy
          # TODO: Enable GitHub Packages mode after first successful publish
          if ('${{ env.USE_GITHUB_PACKAGES }}' -eq 'true') {
            Write-Host ""
            Write-Host "üì¶ Installing K.PSGallery.PackageRepoProvider from GitHub Packages (stable, one-version-behind)..."
            Write-Host "   Source: https://nuget.pkg.github.com/GrexyLoco/index.json"
            
            try {
              # Register temporary repo to install from GitHub Packages
              Register-PSResourceRepository -Name 'GrexyLoco-Temp' `
                -Uri 'https://nuget.pkg.github.com/GrexyLoco/index.json' `
                -Trusted `
                -Verbose
              
              # Install from GitHub Packages
              Install-PSResource -Name K.PSGallery.PackageRepoProvider `
                -Repository 'GrexyLoco-Temp' `
                -Scope CurrentUser `
                -TrustRepository `
                -Verbose
              
              Import-Module K.PSGallery.PackageRepoProvider -Force -Verbose
              Write-Host "‚úÖ Successfully loaded PackageRepoProvider from GitHub Packages"
              
              # Provider will be loaded from GitHub Packages as RequiredModules dependency
              Write-Host "   (GitHub Provider loaded automatically via RequiredModules)"
            }
            catch {
              Write-Host ""
              Write-Host "‚ùå Failed to install from GitHub Packages!"
              Write-Host ""
              Write-Host "üí° Troubleshooting tips:"
              Write-Host "   1. Check if module is published: https://github.com/GrexyLoco?tab=packages"
              Write-Host "   2. Verify GITHUB_TOKEN has packages:read permission"
              Write-Host "   3. For first-time bootstrap: Set use-psgallery=false (use local Git)"
              Write-Host "   4. Error details: $($_.Exception.Message)"
              Write-Host ""
              Write-Host "‚öôÔ∏è  Falling back to LOCAL mode..."
              # Don't throw - fall through to LOCAL mode
              $env:USE_GITHUB_PACKAGES = 'false'
            }
          }
          
          # LOCAL mode (bootstrap or fallback)
          if ('${{ env.USE_GITHUB_PACKAGES }}' -ne 'true') {
            Write-Host ""
            Write-Host "üì¶ Importing LOCAL K.PSGallery.PackageRepoProvider (bootstrap/breaking-changes mode)..."
            Write-Host "   Path: ./K.PSGallery.PackageRepoProvider.psd1"
            Write-Host "   ‚ÑπÔ∏è  Using current Git checkout (self-hosting)"
            
            # Bootstrap: Make provider available for Get-RepoProvider
            $gitHubProviderPath = "./K.PSGallery.PackageRepoProvider.GitHub"
            if (-not (Test-Path "$gitHubProviderPath/K.PSGallery.PackageRepoProvider.GitHub.psd1")) {
              throw "‚ùå GitHub provider module not found at $gitHubProviderPath (checkout failed)"
            }
            Write-Host "   - Bootstrapping GitHub Provider: $gitHubProviderPath"
            Import-Module "$gitHubProviderPath/K.PSGallery.PackageRepoProvider.GitHub.psd1" -Force -Verbose
            
            # Import PackageRepoProvider (will use already-loaded provider via Get-RepoProvider)
            Import-Module ./K.PSGallery.PackageRepoProvider.psd1 -Force -Verbose
            Write-Host "‚úÖ PackageRepoProvider loaded (uses pre-loaded GitHub Provider transparently)"
          }
          
          # Use PackageRepoProvider public API (provider routing is transparent!)
          # Register GitHub Packages repository
          $repoName = "1d70f-Repo"
          $registryUri = "https://nuget.pkg.github.com/GrexyLoco/index.json"
          
          Write-Host ""
          Write-Host "üîß Registering repository: $repoName"
          Write-Host "   URI: $registryUri"
          Register-PackageRepo -RepositoryName $repoName -RegistryUri $registryUri -Token $env:GITHUB_TOKEN -Trusted
          
          # Publish using our own PackageRepoProvider
          Write-Host ""
          Write-Host "üì§ Publishing K.PSGallery.PackageRepoProvider to GitHub Packages..."
          Publish-Package -RepositoryName $repoName -Token $env:GITHUB_TOKEN
          
          Write-Host ""
          Write-Host "‚úÖ Module published successfully to GitHub Packages!"
          Write-Host "   Package: https://github.com/GrexyLoco?tab=packages"
