name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          # Install PSResourceGet if not available
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Force -Scope CurrentUser -SkipPublisherCheck
          }
      
      - name: Run Pester tests
        shell: pwsh
        run: |
          Install-PSResource -Name Pester -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          Invoke-Pester -Path ./Tests/Private/ -Output Detailed
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-PSResource -Name PSScriptAnalyzer -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          
          # Exclude test files (they use ConvertTo-SecureString for mock credentials)
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Error,Warning -ExcludeRule PSReviewUnusedParameter,PSUsePSCredentialType | Where-Object {
            $_.ScriptPath -notlike '*\Tests\*'
          }
          
          if ($results) {
            $results | Format-Table -AutoSize
            throw "PSScriptAnalyzer found $($results.Count) issues in production code"
          }
          Write-Host "âœ… PSScriptAnalyzer passed (production code only)!"
      
      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if (-not $env:PSGALLERY_API_KEY) {
            throw "PSGALLERY_API_KEY secret is not set"
          }
          
          # Update version if manually triggered
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            $version = '${{ inputs.version }}'
            Write-Host "Updating version to $version"
            # Update manifest version here if needed
          }
          
          # Publish module
          Publish-PSResource -Path ./K.PSGallery.PackageRepoProvider.psd1 -ApiKey $env:PSGALLERY_API_KEY -Repository PSGallery
          Write-Host "Module published successfully!"
