name: Build, Test & Publish to GitHub Packages

# üéØ Purpose: Self-publishing pipeline using PackageRepoProvider itself!
# This workflow validates and publishes the module to GitHub Packages using its own logic.
#
# ÔøΩü•ö Bootstrap Problem (Henne-Ei):
# How to publish PackageRepoProvider using itself if it's not published yet?
# Solution: Toggle between LOCAL Git checkout (bootstrap) and GitHub Packages (stable)
#
# üìã Workflow Inputs:
# - use-psgallery: Toggle PackageRepoProvider source (GitHub Packages vs LOCAL)
#
# üìã Repository Variables (optional):
# - USE_GITHUB_PACKAGES: Global default for module loading strategy
#
# üîÑ Module Loading Strategy:
# - LOCAL (default):      Git checkout, bootstrap phase, breaking changes
# - GitHub Packages:      Published version, stable, one-version-behind
#
# Note: Pipeline uses ONLY PackageRepoProvider public API (no direct provider imports!)
#       Provider routing happens transparently inside PackageRepoProvider.

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
      use-psgallery:
        description: 'Load PackageRepoProvider from GitHub Packages (vs LOCAL)'
        required: false
        default: false
        type: boolean

env:
  # üîÑ Module Loading Strategy (Bootstrap Pattern - Henne-Ei Problem)
  # Question: How to publish PackageRepoProvider using itself if it's not published yet?
  # 
  # Controls where K.PSGallery.PackageRepoProvider is loaded from:
  # - false/not set = LOCAL Git checkout (default, bootstrap phase, breaking changes)
  #                   Provider also loaded from Git (not yet published as RequiredModules)
  # - true          = GitHub Packages (self-hosted, stable, one-version-behind)
  #                   Provider loaded from GitHub Packages (after first publish)
  USE_GITHUB_PACKAGES: ${{ inputs.use-psgallery || vars.USE_GITHUB_PACKAGES || 'false' }}

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize Environment
        shell: pwsh
        run: ./.github/scripts/Initialize-Environment.ps1
      
      - name: Run Pester Tests
        shell: pwsh
        run: ./.github/scripts/Test-PesterTests.ps1 -Path './Tests/Private/' -Output 'Detailed'
      
      - name: Run Code Quality Check
        shell: pwsh
        run: ./.github/scripts/Test-CodeQuality.ps1
      
      - name: Load and Publish Module
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if (-not $env:GITHUB_TOKEN) {
            throw "GITHUB_TOKEN is not available"
          }
          
          # Convert token to SecureString
          $secureToken = ConvertTo-SecureString $env:GITHUB_TOKEN -AsPlainText -Force
          
          # Load PackageRepoProvider based on USE_GITHUB_PACKAGES flag
          $useGitHubPackages = [System.Convert]::ToBoolean('${{ env.USE_GITHUB_PACKAGES }}')
          
          if ($useGitHubPackages) {
            Write-Host "üì¶ Loading from GitHub Packages (stable, one-version-behind)..."
            try {
              ./.github/scripts/Install-FromGitHubPackages.ps1 -SecureToken $secureToken
            }
            catch {
              Write-Host ""
              Write-Host "‚ùå Failed to install from GitHub Packages!"
              Write-Host "   Error: $($_.Exception.Message)"
              Write-Host ""
              Write-Host "‚öôÔ∏è  Falling back to LOCAL mode..."
              $useGitHubPackages = $false
            }
          }
          
          if (-not $useGitHubPackages) {
            Write-Host "üèóÔ∏è  Loading from LOCAL Git checkout (bootstrap mode)..."
            ./.github/scripts/Install-FromLocal.ps1 -SecureToken $secureToken
          }
          
          # Publish module
          ./.github/scripts/Publish-ToGitHubPackages.ps1 -SecureToken $secureToken -UseGitHubPackages $useGitHubPackages

