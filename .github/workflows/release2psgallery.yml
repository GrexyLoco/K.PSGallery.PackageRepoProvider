name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          # Install PSResourceGet if not available
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Force -Scope CurrentUser -SkipPublisherCheck
          }
      
      - name: Run Pester tests
        shell: pwsh
        run: |
          Install-PSResource -Name Pester -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          Invoke-Pester -Path ./Tests/Private/ -Output Detailed
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-PSResource -Name PSScriptAnalyzer -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          
          # Only scan production code (Public + Private folders), exclude tests and trailing whitespace warnings
          $paths = @('./Public', './Private')
          $results = $paths | ForEach-Object { 
            Invoke-ScriptAnalyzer -Path $_ -Recurse -Severity Error,Warning -ExcludeRule PSAvoidTrailingWhitespace,PSReviewUnusedParameter 
          }
          
          if ($results) {
            Write-Host "❌ PSScriptAnalyzer found $($results.Count) issues:"
            $results | Format-Table -Property RuleName,Severity,ScriptName,Line -AutoSize
            throw "PSScriptAnalyzer validation failed"
          }
          Write-Host "✅ PSScriptAnalyzer passed!"
      
      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          # use github token as PSGALLERY_API_KEY
          PSGALLERY_API_KEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if (-not $env:PSGALLERY_API_KEY) {
            throw "PSGALLERY_API_KEY secret is not set"
          }
          
          # Update version if manually triggered
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            $version = '${{ inputs.version }}'
            Write-Host "Updating version to $version"
            # Update manifest version here if needed
          }
          
          # Publish module
          Publish-PSResource -Path ./K.PSGallery.PackageRepoProvider.psd1 -ApiKey $env:PSGALLERY_API_KEY -Repository PSGallery
          Write-Host "Module published successfully!"
