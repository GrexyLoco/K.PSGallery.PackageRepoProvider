name: Build, Test & Publish to GitHub Packages

# üéØ Purpose: Self-publishing pipeline using PackageRepoProvider itself!
# This workflow validates and publishes the module to GitHub Packages using its own logic.
#
# ÔøΩü•ö Bootstrap Problem (Henne-Ei):
# How to publish PackageRepoProvider using itself if it's not published yet?
# Solution: Toggle between LOCAL Git checkout (bootstrap) and GitHub Packages (stable)
#
# üìã Workflow Inputs:
# - use-psgallery: Toggle PackageRepoProvider source (GitHub Packages vs LOCAL)
#
# üìã Repository Variables (optional):
# - USE_GITHUB_PACKAGES: Global default for module loading strategy
#
# üîÑ Module Loading Strategy:
# - LOCAL (default):      Git checkout, bootstrap phase, breaking changes
# - GitHub Packages:      Published version, stable, one-version-behind
#
# Note: Pipeline uses ONLY PackageRepoProvider public API (no direct provider imports!)
#       Provider routing happens transparently inside PackageRepoProvider.

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
      use-psgallery:
        description: 'Load PackageRepoProvider from GitHub Packages (vs LOCAL)'
        required: false
        default: false
        type: boolean

env:
  # üîÑ Module Loading Strategy (Bootstrap Pattern - Henne-Ei Problem)
  # Question: How to publish PackageRepoProvider using itself if it's not published yet?
  # 
  # Controls where K.PSGallery.PackageRepoProvider is loaded from:
  # - false/not set = LOCAL Git checkout (default, bootstrap phase, breaking changes)
  #                   Provider also loaded from Git (not yet published as RequiredModules)
  # - true          = GitHub Packages (self-hosted, stable, one-version-behind)
  #                   Provider loaded from GitHub Packages (after first publish)
  USE_GITHUB_PACKAGES: ${{ inputs.use-psgallery || vars.USE_GITHUB_PACKAGES || 'false' }}

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PowerShell
        shell: pwsh
        run: |
          Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
          
          # Install latest PREVIEW version of PSResourceGet (1.2.0-preview3 fixes "No author" bug)
          Write-Output "Installing Microsoft.PowerShell.PSResourceGet PREVIEW..."
          Install-PSResource -Name Microsoft.PowerShell.PSResourceGet -Prerelease -Scope CurrentUser -TrustRepository -Reinstall -Verbose
          
          # Install SecretManagement (required dependency of PSResourceGet 1.2.0+)
          # PSResourceGet 1.2.0+ requires SecretManagement even when explicit -Credential is provided
          Write-Output "Installing Microsoft.PowerShell.SecretManagement..."
          Install-PSResource -Name Microsoft.PowerShell.SecretManagement -Scope CurrentUser -TrustRepository -Verbose

          # Verify version
          $version = (Get-Module Microsoft.PowerShell.PSResourceGet -ListAvailable | Sort-Object Version -Descending | Select-Object -First 1).Version
          Write-Output "‚úÖ PSResourceGet Version: $version"
      
      - name: Run Pester tests
        shell: pwsh
        run: |
          Install-PSResource -Name Pester -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          Invoke-Pester -Path ./Tests/Private/ -Output Detailed
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-PSResource -Name PSScriptAnalyzer -Scope CurrentUser -TrustRepository -SkipDependencyCheck
          
          # Only scan production code (Public + Private folders), exclude tests and trailing whitespace warnings
          $paths = @('./Public', './Private')
          $results = $paths | ForEach-Object { 
            Invoke-ScriptAnalyzer -Path $_ -Recurse -Severity Error,Warning -ExcludeRule PSAvoidTrailingWhitespace,PSReviewUnusedParameter 
          }
          
          if ($results) {
            Write-Output "‚ùå PSScriptAnalyzer found $($results.Count) issues:"
            $results | Format-Table -Property RuleName,Severity,ScriptName,Line -AutoSize
            throw "PSScriptAnalyzer validation failed"
          }
          Write-Output "‚úÖ PSScriptAnalyzer passed!"
      
      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if (-not $env:GITHUB_TOKEN) {
            throw "GITHUB_TOKEN is not available"
          }
          
          # Convert to boolean (case-insensitive: 'true', 'True', 'TRUE' all work)
          $useGitHubPackages = [System.Convert]::ToBoolean('${{ env.USE_GITHUB_PACKAGES }}')
          
          # ÔøΩ Load PackageRepoProvider based on bootstrap strategy
          # TODO: Enable GitHub Packages mode after first successful publish
          if ($useGitHubPackages) {
            Write-Output ""
            Write-Output "üì¶ Installing K.PSGallery.PackageRepoProvider from GitHub Packages (stable, one-version-behind)..."
            Write-Output "   Source: https://nuget.pkg.github.com/GrexyLoco/index.json"
            
            try {
              # Bootstrap: Use Microsoft's cmdlets directly (our wrapper functions not yet available)
              # Convert token to PSCredential
              $secureToken = ConvertTo-SecureString $env:GITHUB_TOKEN -AsPlainText -Force
              $credential = [PSCredential]::new('token', $secureToken)
              
              # Register temporary repo WITHOUT credentials (avoid vault requirement)
              # Credentials will be provided at install time
              Register-PSResourceRepository -Name 'GrexyLoco-Temp' `
                -Uri 'https://nuget.pkg.github.com/GrexyLoco/index.json' `
                -Trusted `
                -Verbose
              
              # Install from GitHub Packages with credentials
              Install-PSResource -Name K.PSGallery.PackageRepoProvider `
                -Repository 'GrexyLoco-Temp' `
                -Scope CurrentUser `
                -TrustRepository `
                -Credential $credential `
                -Verbose
              
              Import-Module K.PSGallery.PackageRepoProvider -Force -Verbose
              Write-Output "‚úÖ Successfully loaded PackageRepoProvider from GitHub Packages"
              Write-Output "   ‚ÑπÔ∏è  GitHub Provider will be auto-installed if needed (pluggable architecture)"
            }
            catch {
              Write-Output ""
              Write-Output "‚ùå Failed to install from GitHub Packages!"
              Write-Output ""
              Write-Output "üí° Troubleshooting tips:"
              Write-Output "   1. Check if module is published: https://github.com/GrexyLoco?tab=packages"
              Write-Output "   2. Verify GITHUB_TOKEN has packages:read permission"
              Write-Output "   3. For first-time bootstrap: Set use-psgallery=false (use local Git)"
              Write-Output "   4. Error details: $($_.Exception.Message)"
              Write-Output ""
              Write-Output "‚öôÔ∏è  Falling back to LOCAL mode..."
              # Don't throw - fall through to LOCAL mode
              $useGitHubPackages = $false
            }
          }
          
          # LOCAL mode (bootstrap or fallback)
          if (-not $useGitHubPackages) {
            Write-Output ""
            Write-Output "üì¶ Importing LOCAL K.PSGallery.PackageRepoProvider (bootstrap/breaking-changes mode)..."
            Write-Output "   Path: ./K.PSGallery.PackageRepoProvider.psd1"
            Write-Output "   ‚ÑπÔ∏è  Using current Git checkout (self-hosting)"
            
            # Install GitHub provider manually (pluggable architecture - no RequiredModules)
            Write-Output ""
            Write-Output "üîß Installing GitHub provider module..."
            $secureToken = ConvertTo-SecureString $env:GITHUB_TOKEN -AsPlainText -Force
            $credential = [PSCredential]::new('token', $secureToken)
            
            # Register temporary repository for provider installation
            Register-PSResourceRepository -Name 'GrexyLoco-Bootstrap' `
              -Uri 'https://nuget.pkg.github.com/GrexyLoco/index.json' `
              -Trusted `
              -Verbose
            
            # Install GitHub provider module
            Install-PSResource -Name 'K.PSGallery.PackageRepoProvider.GitHub' `
              -Repository 'GrexyLoco-Bootstrap' `
              -Scope CurrentUser `
              -TrustRepository `
              -Credential $credential `
              -Verbose
            
            Write-Output "‚úÖ GitHub provider installed"
            
            # Import PackageRepoProvider (providers loaded dynamically when needed)
            Import-Module ./K.PSGallery.PackageRepoProvider.psd1 -Force -Verbose
            Write-Output "‚úÖ PackageRepoProvider loaded (providers will be loaded dynamically)"
          }
          
          # Use PackageRepoProvider public API (provider routing is transparent!)
          # Register GitHub Packages repository
          $repoName = "1d70f-Repo"
          $registryUri = "https://nuget.pkg.github.com/GrexyLoco/index.json"
          
          Write-Output ""
          Write-Output "üîß Registering repository: $repoName"
          Write-Output "   URI: $registryUri"
          Register-PackageRepo -RepositoryName $repoName -RegistryUri $registryUri -Token $env:GITHUB_TOKEN -Trusted
          
          # Publish using our own PackageRepoProvider
          # The module automatically builds .nupkg to bypass Author Runspace Bug
          Write-Output ""
          Write-Output "üì§ Publishing K.PSGallery.PackageRepoProvider to GitHub Packages..."
          Write-Output "   Module will automatically build .nupkg to bypass Author Runspace Bug"
          
          try {
            Publish-Package -RepositoryName $repoName -Token $env:GITHUB_TOKEN -Verbose
            
            Write-Output ""
            Write-Output "‚úÖ Module published successfully to GitHub Packages!"
            
            # GitHub Actions Step Summary
            $summary = @"
          ## ‚úÖ Publish Successful
          
          **Module:** ``K.PSGallery.PackageRepoProvider``
          
          | Property | Value |
          |----------|-------|
          | üéØ Repository | ``$repoName`` |
          | üîó Registry | ``$registryUri`` |
          | üîÑ Load Mode | $(if ($useGitHubPackages) { 'üì¶ GitHub Packages (stable)' } else { 'üèóÔ∏è LOCAL Bootstrap' }) |
          | üì¶ Build Mode | ‚ú® .nupkg Pre-Build (Author Bug Fix) |
          | üì¶ Package URL | [View Package](https://github.com/GrexyLoco?tab=packages) |
          
          ### üöÄ Installation
          
          ```powershell
          # Register repository
          Register-PackageRepo -RepositoryName '$repoName' -RegistryUri '$registryUri' -Token `$env:GITHUB_TOKEN -Trusted
          
          # Install module
          Install-PackageModule -RepositoryName '$repoName' -ModuleName 'K.PSGallery.PackageRepoProvider' -Token `$env:GITHUB_TOKEN
          ```
          
          ### üìã Version Options
          
          ```powershell
          # Latest version
          Install-PackageModule -RepositoryName '$repoName' -ModuleName 'K.PSGallery.PackageRepoProvider' -Token `$env:GITHUB_TOKEN
          
          # Latest 1.x.x
          Install-PackageModule -RepositoryName '$repoName' -ModuleName 'K.PSGallery.PackageRepoProvider' -Version '1' -Token `$env:GITHUB_TOKEN
          
          # Specific version
          Install-PackageModule -RepositoryName '$repoName' -ModuleName 'K.PSGallery.PackageRepoProvider' -Version '0.1.0' -Token `$env:GITHUB_TOKEN
          ```
          "@
            
            $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            Write-Output "üìä Summary written to GitHub Actions UI"
          }
          catch {
            Write-Output ""
            Write-Output "‚ùå PUBLISH FAILED"
            Write-Output "üí• Error: $($_.Exception.Message)"
            
            # GitHub Actions Step Summary - Error
            $errorSummary = @"
          ## ‚ùå Publish Failed
          
          **Error:** ``$($_.Exception.Message)``
          
          ### üîç Diagnostics
          
          | Property | Value |
          |----------|-------|
          | üéØ Repository | ``$repoName`` |
          | üîó Registry | ``$registryUri`` |
          | üîÑ Load Mode | $(if ($useGitHubPackages) { 'üì¶ GitHub Packages' } else { 'üèóÔ∏è LOCAL Bootstrap' }) |
          | üîë Auth Token | $(if ($env:GITHUB_TOKEN) { '‚úÖ Present' } else { '‚ùå Missing' }) |
          
          ### üí° Common Issues
          
          - Check ``GITHUB_TOKEN`` has ``packages:write`` permission
          - Verify module manifest is valid: ``Test-ModuleManifest``
          - Ensure ``PSResourceGet`` is installed: ``Get-Module PSResourceGet -ListAvailable``
          - Check repository registration: ``Get-PSResourceRepository``
          - Review [PSResourceGet Documentation](https://learn.microsoft.com/powershell/module/microsoft.powershell.psresourceget/)
          
          ### üìã Troubleshooting Steps
          
          1. **Verify PSResourceGet version:**
             ``````powershell
             Get-Module Microsoft.PowerShell.PSResourceGet -ListAvailable | Select-Object Version
             ``````
          
          2. **Check registered repositories:**
             ``````powershell
             Get-PSResourceRepository
             ``````
          
          3. **Validate manifest:**
             ``````powershell
             Test-ModuleManifest -Path ./K.PSGallery.PackageRepoProvider.psd1
             ``````
          "@
            
            $errorSummary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            Write-Output "üìä Error summary written to GitHub Actions UI"
            throw
          }
